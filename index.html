<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cute Economic Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    ðŸ“Š Cute Economic Dashboard
    <div id="lastUpdated" style="font-size:0.9rem; font-weight:normal;"></div>
  </header>

  <div class="container" id="data-container">
    <!-- FRED Economic Indicators -->
    <div class="card">
      <h2>GDP (ðŸ‡ºðŸ‡¸ USA)</h2>
      <p id="gdp" class="value">Loading...</p>
      <canvas id="gdpChart"></canvas>
    </div>
    <div class="card">
      <h2>Unemployment (ðŸ‡ºðŸ‡¸ USA)</h2>
      <p id="unrate" class="value">Loading...</p>
      <canvas id="unrateChart"></canvas>
    </div>
    <div class="card">
      <h2>CPI Inflation (YoY, ðŸ‡ºðŸ‡¸ USA)</h2>
      <p id="cpi" class="value">Loading...</p>
      <canvas id="cpiChart"></canvas>
    </div>
    <div class="card">
      <h2>PCE Inflation (YoY, ðŸ‡ºðŸ‡¸ USA)</h2>
      <p id="pce" class="value">Loading...</p>
      <canvas id="pceChart"></canvas>
    </div>
    <div class="card">
      <h2>10Y Treasury Yield (Live, ðŸ‡ºðŸ‡¸)</h2>
      <p id="gs10" class="value">Loading...</p>
      <canvas id="gs10Chart"></canvas>
    </div>
    <div class="card">
      <h2>5Y Inflation Expectation (Proxy: TIPS, ðŸ‡ºðŸ‡¸)</h2>
      <p id="t5yie" class="value">Loading...</p>
      <canvas id="t5yieChart"></canvas>
    </div>

    <!-- Market Indexes -->
    <div class="card">
      <h2>S&P 500 (ðŸ‡ºðŸ‡¸)</h2>
      <p id="sp500" class="value">Loading...</p>
      <canvas id="sp500Chart"></canvas>
    </div>
    <div class="card">
      <h2>Dow Jones (ðŸ‡ºðŸ‡¸)</h2>
      <p id="dji" class="value">Loading...</p>
      <canvas id="djiChart"></canvas>
    </div>
    <div class="card">
      <h2>Nasdaq (ðŸ‡ºðŸ‡¸)</h2>
      <p id="ixic" class="value">Loading...</p>
      <canvas id="ixicChart"></canvas>
    </div>
    <div class="card">
      <h2>Russell 2000 (ðŸ‡ºðŸ‡¸)</h2>
      <p id="rut" class="value">Loading...</p>
      <canvas id="rutChart"></canvas>
    </div>

    <!-- Global Indexes -->
    <div class="card">
      <h2>FTSE 100 (ðŸ‡¬ðŸ‡§ UK)</h2>
      <p id="ftse" class="value">Loading...</p>
      <canvas id="ftseChart"></canvas>
    </div>
    <div class="card">
      <h2>Nikkei 225 (ðŸ‡¯ðŸ‡µ Japan)</h2>
      <p id="n225" class="value">Loading...</p>
      <canvas id="n225Chart"></canvas>
    </div>
    <div class="card">
      <h2>DAX (ðŸ‡©ðŸ‡ª Germany)</h2>
      <p id="gdaxi" class="value">Loading...</p>
      <canvas id="gdaxiChart"></canvas>
    </div>
    <div class="card">
      <h2>Hang Seng (ðŸ‡­ðŸ‡° Hong Kong)</h2>
      <p id="hsi" class="value">Loading...</p>
      <canvas id="hsiChart"></canvas>
    </div>
    <div class="card">
      <h2>Shanghai Composite (ðŸ‡¨ðŸ‡³ China)</h2>
      <p id="shcomp" class="value">Loading...</p>
      <canvas id="shcompChart"></canvas>
    </div>
  </div>

  <script>
    // --- Last updated ---
    document.getElementById("lastUpdated").innerText =
      "Last updated: " + new Date().toLocaleString();

    // --- Number formatting helper ---
    function formatNumber(value, type="number") {
      if (value == null || isNaN(value)) return "N/A";
      switch (type) {
        case "money":
          return `$${(value/1000).toFixed(1)}T`; // GDP is billions
        case "percent":
          return value.toFixed(2) + "%";
        case "index":
          return value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        default:
          return value.toFixed(2);
      }
    }

    // --- FRED (via Netlify proxy). We'll compute YoY on the client for CPI/PCE. ---
    async function fetchFRED(seriesId, elementId, chartId, options = {}) {
      const { displayType="number", transform=null } = options; // transform: null | 'yoy'
      try {
        const url = `/.netlify/functions/fred?series=${seriesId}`;
        const res = await fetch(url);
        const data = await res.json();

        let obs = (data.observations || [])
          .filter(o => o.value !== "." && !isNaN(parseFloat(o.value)))
          .map(o => ({ date: o.date, value: parseFloat(o.value) }));

        if (obs.length === 0) {
          document.getElementById(elementId).innerText = "No data";
          return;
        }

        // Optional: compute YoY % (monthly series)
        if (transform === "yoy") {
          const yoy = [];
          for (let i = 12; i < obs.length; i++) {
            const prev = obs[i - 12].value;
            const curr = obs[i].value;
            if (prev && !isNaN(prev)) {
              yoy.push({
                date: obs[i].date,
                value: ((curr - prev) / prev) * 100
              });
            }
          }
          obs = yoy;
        }

        // Latest value for the card
        const latest = obs[obs.length - 1]?.value;
        document.getElementById(elementId).innerText = formatNumber(latest, displayType);

        // Chart (last N points)
        const recent = obs.slice(-20);
        const labels = recent.map(o => o.date);
        const values = recent.map(o => o.value);

        new Chart(document.getElementById(chartId), {
          type: "line",
          data: {
            labels,
            datasets: [{
              label: seriesId + (transform === "yoy" ? " (YoY %)" : ""),
              data: values,
              borderColor: "#cc0066",
              fill: false,
              tension: 0.2
            }]
          },
          options: { scales: { x: { display: false } } }
        });
      } catch (err) {
        console.error("FRED error", seriesId, err);
        document.getElementById(elementId).innerText = "Error";
      }
    }

    // --- Yahoo Finance (via Netlify proxy) ---
    // Supports showYTD header toggle (use false for 10Y yield)
    async function fetchYahoo(symbol, elementId, chartId, options = {}) {
      const { displayType="index", showYTD=true } = options;
      try {
        const url = `/.netlify/functions/yahoo?symbol=${symbol}`;
        const res = await fetch(url);
        const data = await res.json();

        const result = data.chart.result[0];
        const pricesRaw = result.indicators.quote[0].close;
        const timestamps = result.timestamp.map(t => new Date(t * 1000).toLocaleDateString());
        const prices = pricesRaw.filter(v => v != null);

        const firstVal = prices[0];
        const lastVal  = prices[prices.length - 1];

        // Card text
        if (showYTD) {
          const pctChange = ((lastVal - firstVal) / firstVal) * 100;
          document.getElementById(elementId).innerHTML =
            `<span style="color:${pctChange >= 0 ? 'green' : 'red'};">
              ${pctChange.toFixed(2)}% YTD
            </span><br>${formatNumber(lastVal, displayType)}`;
        } else {
          // No % header (for ^TNX)
          document.getElementById(elementId).innerText =
            formatNumber(lastVal, displayType);
        }

        new Chart(document.getElementById(chartId), {
          type: "line",
          data: {
            labels: timestamps,
            datasets: [{
              label: symbol,
              data: pricesRaw, // keep original length to align labels
              borderColor: "#ff3399",
              fill: false,
              tension: 0.2
            }]
          },
          options: { scales: { x: { display: false } } }
        });
      } catch (err) {
        console.error("Yahoo error", symbol, err);
        document.getElementById(elementId).innerText = "Error";
      }
    }

    // --- Load FRED Indicators ---
    // GDP: billions -> money (trillions)
    fetchFRED("GDP", "gdp", "gdpChart", { displayType: "money" });

    // Unemployment: already %
    fetchFRED("UNRATE", "unrate", "unrateChart", { displayType: "percent" });

    // CPI YoY % (computed here)
    fetchFRED("CPIAUCSL", "cpi", "cpiChart", { displayType: "percent", transform: "yoy" });

    // PCE YoY % (computed here)
    fetchFRED("PCEPI", "pce", "pceChart", { displayType: "percent", transform: "yoy" });

    // --- Load Yahoo Indicators ---
    // 10Y yield: show ONLY latest % (no YTD header)
    fetchYahoo("^TNX", "gs10", "gs10Chart", { displayType: "percent", showYTD: false });

    // Inflation proxy (TIPS ETF): keep YTD
    fetchYahoo("TIP", "t5yie", "t5yieChart", { displayType: "index", showYTD: true });

    // --- Load Yahoo Indexes (with YTD header) ---
    fetchYahoo("^GSPC", "sp500", "sp500Chart", { displayType: "index", showYTD: true });
    fetchYahoo("^DJI",  "dji",   "djiChart",   { displayType: "index", showYTD: true });
    fetchYahoo("^IXIC", "ixic",  "ixicChart",  { displayType: "index", showYTD: true });
    fetchYahoo("^RUT",  "rut",   "rutChart",   { displayType: "index", showYTD: true });

    fetchYahoo("^FTSE",    "ftse",   "ftseChart",   { displayType: "index", showYTD: true });
    fetchYahoo("^N225",    "n225",   "n225Chart",   { displayType: "index", showYTD: true });
    fetchYahoo("^GDAXI",   "gdaxi",  "gdaxiChart",  { displayType: "index", showYTD: true });
    fetchYahoo("^HSI",     "hsi",    "hsiChart",    { displayType: "index", showYTD: true });
    fetchYahoo("000001.SS","shcomp", "shcompChart", { displayType: "index", showYTD: true });
  </script>
</body>
</html>
