<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Economic Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    Economic Dashboard
    <div id="lastUpdated" style="font-size:0.9rem; font-weight:normal;"></div>
  </header>

  <!-- Macroeconomic Data -->
  <h2 class="section-header">Macroeconomic Data</h2>
  <h3 class="sub-header">Growth & Inflation</h3>
  <div class="container">
    <div class="card"><h2>GDP (US)</h2><p id="gdp" class="value">Loading...</p><canvas id="gdpChart"></canvas></div>
    <div class="card"><h2>Unemployment (US)</h2><p id="unrate" class="value">Loading...</p><canvas id="unrateChart"></canvas></div>
    <div class="card"><h2>CPI Inflation YoY (US)</h2><p id="cpi" class="value">Loading...</p><canvas id="cpiChart"></canvas></div>
    <div class="card"><h2>PCE Inflation YoY (US)</h2><p id="pce" class="value">Loading...</p><canvas id="pceChart"></canvas></div>
    <div class="card"><h2>PPI Inflation YoY (US)</h2><p id="ppi" class="value">Loading...</p><canvas id="ppiChart"></canvas></div>
  </div>

  <h3 class="sub-header">Rates & Expectations</h3>
  <div class="container">
    <div class="card"><h2>SOFR (US)</h2><p id="sofr" class="value">Loading...</p><canvas id="sofrChart"></canvas></div>
    <div class="card"><h2>Fed Funds Rate (US)</h2><p id="fedfunds" class="value">Loading...</p><canvas id="fedfundsChart"></canvas></div>
    <div class="card"><h2>10Y Treasury Yield (US)</h2><p id="gs10" class="value">Loading...</p><canvas id="gs10Chart"></canvas></div>
    <div class="card"><h2>5Y Breakeven Inflation (US)</h2><p id="t5yie" class="value">Loading...</p><canvas id="t5yieChart"></canvas></div>
  </div>

  <!-- Market Indexes -->
  <h2 class="section-header">Market Indexes</h2>
  <h3 class="sub-header">US Indexes</h3>
  <div class="container">
    <div class="card"><h2>S&P 500</h2><p id="sp500" class="value">Loading...</p><canvas id="sp500Chart"></canvas></div>
    <div class="card"><h2>Dow Jones</h2><p id="dji" class="value">Loading...</p><canvas id="djiChart"></canvas></div>
    <div class="card"><h2>Nasdaq</h2><p id="ixic" class="value">Loading...</p><canvas id="ixicChart"></canvas></div>
    <div class="card"><h2>Russell 2000</h2><p id="rut" class="value">Loading...</p><canvas id="rutChart"></canvas></div>
  </div>

  <h3 class="sub-header">Global Indexes</h3>
  <div class="container">
    <div class="card"><h2>FTSE 100 (UK)</h2><p id="ftse" class="value">Loading...</p><canvas id="ftseChart"></canvas></div>
    <div class="card"><h2>Nikkei 225 (Japan)</h2><p id="n225" class="value">Loading...</p><canvas id="n225Chart"></canvas></div>
    <div class="card"><h2>DAX (Germany)</h2><p id="gdaxi" class="value">Loading...</p><canvas id="gdaxiChart"></canvas></div>
    <div class="card"><h2>Hang Seng (Hong Kong)</h2><p id="hsi" class="value">Loading...</p><canvas id="hsiChart"></canvas></div>
    <div class="card"><h2>Shanghai Composite (China)</h2><p id="shcomp" class="value">Loading...</p><canvas id="shcompChart"></canvas></div>
  </div>

  <script>
  document.getElementById("lastUpdated").innerText =
    "Last updated: " + new Date().toLocaleString();

  function formatNumber(value, type="number") {
    if (value == null || isNaN(value)) return "N/A";
    switch (type) {
      case "money": 
        return `$${(value / 1000).toFixed(2)}T`; // GDP in trillions
      case "percent": 
        return value.toFixed(5) + "%";
      case "index": 
        return value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      default: 
        return value.toFixed(2);
    }
  }

  // ---------- FRED fetch (via backend now) ----------
  async function fetchFRED(seriesId, elementId, chartId, options = {}) {
  const { displayType="number", transform=null } = options;
  try {
    const url = `https://economic-dashboard-backend.onrender.com/fred/${seriesId}${transform ? "?transform=" + transform : ""}`;
    const res = await fetch(url);
    const data = await res.json();
    if (data.error) throw new Error(data.error);

    // Use backend-provided history + latest
    const obs = data.history;
    const latest = data.latest;

    // Show latest number
    document.getElementById(elementId).innerText = formatNumber(latest, displayType);

    // Chart recent values
    const recent = obs.slice(-20);
    new Chart(document.getElementById(chartId), {
      type: "line",
      data: {
        labels: recent.map(o => o.date),
        datasets: [{ data: recent.map(o => o.value), borderColor: "#cc0066", fill: false, tension: 0.2 }]
      },
      options: { plugins: { legend: { display: false } }, scales: { x: { display: false } } }
    });
  } catch (err) {
    console.error("FRED error", seriesId, err);
    document.getElementById(elementId).innerText = "Error";
  }
}


  // ---------- Yahoo fetch (already backend) ----------
  async function fetchBackend(symbol, elementId, chartId, options = {}) {
    const { displayType = "index", showYTD = true } = options;
    try {
      const url = `https://economic-dashboard-backend.onrender.com/quote/${encodeURIComponent(symbol)}`;
      const res = await fetch(url);
      const data = await res.json();
      if (data.error) throw new Error(data.error);

      const prices = data.history.values;
      const dates = data.history.dates;

      if (showYTD && typeof data.ytd_change === "number") {
        const pctChange = data.ytd_change;
        document.getElementById(elementId).innerHTML =
          `<span style="color:${pctChange >= 0 ? 'green' : 'red'};">
            ${pctChange.toFixed(2)}% YTD
          </span><br>${formatNumber(data.latest, displayType)}`;
      } else {
        document.getElementById(elementId).innerText = formatNumber(data.latest, displayType);
      }

      new Chart(document.getElementById(chartId), {
        type: "line",
        data: {
          labels: dates,
          datasets: [{ data: prices, borderColor: "#ff3399", fill: false, tension: 0.2 }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { x: { display: true, ticks: { autoSkip: true, maxTicksLimit: 6 } } }
        }
      });
    } catch (err) {
      console.error("Backend error", symbol, err);
      document.getElementById(elementId).innerText = "Error";
    }
  }

  // ---------- Load FRED Data ----------
  // ---------- Load FRED Data ----------
  // Growth & Inflation
  fetchFRED("GDP", "gdp", "gdpChart", { displayType: "money" });            // Nominal GDP (billions)
  fetchFRED("UNRATE", "unrate", "unrateChart", { displayType: "percent" });
  fetchFRED("CPIAUCSL", "cpi", "cpiChart", { displayType: "percent", transform: "yoy" });
  fetchFRED("PCEPI", "pce", "pceChart", { displayType: "percent", transform: "yoy" });
  fetchFRED("PPIACO", "ppi", "ppiChart", { displayType: "percent", transform: "yoy" });

  // Rates & Expectations
  fetchFRED("SOFR", "sofr", "sofrChart", { displayType: "percent" });       // Overnight rate (daily)
  fetchFRED("FEDFUNDS", "fedfunds", "fedfundsChart", { displayType: "percent" });
  fetchFRED("GS10", "gs10", "gs10Chart", { displayType: "percent" });
  fetchFRED("T5YIE", "t5yie", "t5yieChart", { displayType: "percent" });



  // ---------- Load Yahoo Indexes ----------
  fetchBackend("^GSPC", "sp500", "sp500Chart");
  fetchBackend("^DJI", "dji", "djiChart");
  fetchBackend("^IXIC", "ixic", "ixicChart");
  fetchBackend("^RUT", "rut", "rutChart");
  fetchBackend("^FTSE", "ftse", "ftseChart");
  fetchBackend("^N225", "n225", "n225Chart");
  fetchBackend("^GDAXI", "gdaxi", "gdaxiChart");
  fetchBackend("^HSI", "hsi", "hsiChart");
  fetchBackend("000001.SS", "shcomp", "shcompChart");
</script>

</body>
</html>
